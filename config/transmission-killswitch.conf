# transmission-killswitch.conf - PF anchor rules for Transmission VPN kill-switch
#
# These rules enforce that the _transmission user can ONLY communicate via
# VPN tunnel interfaces (utun*) and loopback. All other traffic is blocked
# at the kernel level using a default-deny model.
#
# This is a fail-closed design:
# - VPN up:   Traffic flows through utun -> allowed
# - VPN down: No utun interface -> all traffic blocked (no DNS, no peers, nothing)
# - New physical interface (USB Ethernet, etc.): blocked by default
#
# Deployed to: /etc/pf.anchors/transmission-killswitch
# Loaded by:   /Library/LaunchDaemons/com.tilsit.pf-killswitch.plist
#
# To test manually:
#   sudo pfctl -a "transmission-killswitch" -f /etc/pf.anchors/transmission-killswitch
#   sudo pfctl -e
#   sudo -u _transmission curl --max-time 5 https://ifconfig.me  # should show VPN IP
#   sudo -u _transmission curl --interface en0 --max-time 5 https://ifconfig.me  # should timeout

# Allow _transmission on loopback â€” required for:
# - RPC web UI access (localhost:19091)
# - Plex API calls from completion script (localhost:32400)
# - Local inter-process communication
pass out quick on lo0 proto { tcp, udp } user _transmission

# Allow _transmission on VPN tunnel interfaces
# PIA and most VPN clients use utun interfaces; we allow a wide range
# to accommodate dynamic interface assignment
pass out quick on utun0 proto { tcp, udp } user _transmission
pass out quick on utun1 proto { tcp, udp } user _transmission
pass out quick on utun2 proto { tcp, udp } user _transmission
pass out quick on utun3 proto { tcp, udp } user _transmission
pass out quick on utun4 proto { tcp, udp } user _transmission
pass out quick on utun5 proto { tcp, udp } user _transmission
pass out quick on utun6 proto { tcp, udp } user _transmission
pass out quick on utun7 proto { tcp, udp } user _transmission
pass out quick on utun8 proto { tcp, udp } user _transmission
pass out quick on utun9 proto { tcp, udp } user _transmission

# DEFAULT DENY: Block _transmission on ALL other interfaces
# This catches en0, en1, en2, and any future physical/virtual interfaces.
# Uses default-deny so new interfaces are blocked without rule updates.
block drop out quick proto { tcp, udp } user _transmission

# NOTE: No blanket DNS pass rule. When VPN is up, DNS goes through utun.
# When VPN is down, DNS is also blocked (fail-closed). This is correct.
